<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>create pathway</title>
    <link rel="stylesheet" href="/styles/styles.css">
    <link rel="stylesheet" href="/styles/custom.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  </head>
  <body class="leading-normal tracking-normal text-white gradient" style="font-family: 'Source Sans Pro', sans-serif;" cz-shortcut-listen="true">
    <input type="hidden" id="users" value=<%= JSON.stringify(users)%>>
    <input type="hidden" id="rules" value=<%= JSON.stringify(rules)%>>
    <input type="hidden" id="categories"  value=<%= JSON.stringify(categories)%>>
    <input type="hidden" id="deployments"  value=<%= JSON.stringify(deployments)%>>
    <%- include('../components/_header')  %> 
    <input type="button" value="戻る" onclick="history.back()">
    <section>create pathway</section>
    <form action="/api/pathway_create" method="post" class="text-black">
      <table class="formTable">
        <tbody>
          <tr valign="top">
          <th rowspan="1" align="left" nowrap="">名称</th>
          <td nowrap="">
            <input type="text" name="workflow" value="" size="40"  maxlength="100">
            <div class="fieldComment"> <tt>ワークフローの名称を記入してください</tt></div>
          </td>
          </tr>
          <tr valign="top">
            <th rowspan="1" align="left" nowrap="">部署名</th>
            <td nowrap=""><select name="deployments" id="deployment_all"></select></td>
          </tr>
          <tr valign="top">
            <th rowspan="1" align="left" nowrap=""><b>申請経路</b></th>
            <td nowrap="">
              <div class="flex flex-row">
                <div>
                  <span nowrap=""><br></span>
                  <span>↓</span>
                </div>
                <div>
                  <table id="pathway_table">
                    <tr>
                      <th nowrap="">経路種別</th>
                      <th nowrap="">役割</th>
                      <th nowrap="">処理者</th>
                    </tr>
                  </table>
                </div>
                <div>
                  <span><br></span>
                  <div class="flex flex-row">
                    <div class="flex flex-col">
                      <span><input type="button" class="" id="add_emp" value="← 追加" /></span>
                      <span><input type="button" class="" id="dlt_emp" value="→ 削除" /></span>
                    </div>
                    <select id="employee_all" class="" name="is_invalid" size="5" multiple></select>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </form>
    <button type="submit" class="mx-auto lg:mx-0 w-full hover:underline gradient my-2 py-2 px-8 rounded-full text-5xl font-bold leading-tight text-center text-white shadow-lg">作成する</button>
    <script>
      'use strict';
      document.addEventListener('DOMContentLoaded', function () {
        const users = JSON.parse(document.getElementById('users').value);
        const deployments = JSON.parse(document.getElementById('deployments').value);
        const rules = JSON.parse(document.getElementById('rules').value);
        const categories = JSON.parse(document.getElementById('categories').value);
        const add_emp = document.getElementById('add_emp');
        const dlt_emp = document.getElementById('dlt_emp');
        const pathway_table = document.getElementById("pathway_table");
        
        users.forEach(user => {
          $('#employee_all').append(`<option value=${user.id}>${user.name}</option>`);
        })
        deployments.forEach(deployment => {
          $('#deployment_all').append(`<option value=${deployment.id}>${deployment.name}</option>`)
        })
        
        
        function destroy_af_fa(value , id) {
          $(value).remove(value);
          let index = fa_arr.indexOf(id);
          fa_arr.splice(index,1);
        };
        
        add_emp.addEventListener('click', () => {
          let select = document.getElementById('employee_all');
          for (let i = 0; i < select.length; i++) {
            if (select[i].selected === true) {
              add_row(select[i].innerHTML);
            }
          }
        })

        dlt_emp.addEventListener('click', () => {
          del_row()
        })
        
        //行追加
        function add_row(proccessor){
          let tr = document.createElement("tr"); 
          for(let i=0; i<3; i++){
            let td = document.createElement("td");
            switch (i) {
              case 0:
                td.innerHTML = "";
                break;;
              case 1:
                td.innerHTML = `<select name="rules" id="rules"></select>`;
                rules.forEach(rule => {
                  $('#rules').append(`<option value=${rule.id}>${rule.name}</option>`);
                })
                break;;
              case 2:
                td.innerHTML = proccessor;
                break;
              default:
                console.log(i);
            }
            tr.appendChild(td);
          }
          pathway_table.appendChild(tr);  
        }

        //末尾行削除
        function del_row(){
          let rw = pathway_table.rows.length;
          rw === 1 ? "": pathway_table.deleteRow(rw-1);
        }
      })
    </script>
  </body>
</html>

